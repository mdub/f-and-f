#! /usr/bin/env ruby

$: << File.expand_path("../../lib", __FILE__)

require "clamp"
require "faith_and_farming/book"
require "yaml"

Clamp do

  subcommand "page", "page commands" do

    parameter "N", "page number", :attribute_name => :page_index

    def execute
      page.blocks.each do |block|
        bounds = block.bounds
        puts "\n--- {left #{bounds.left}, right #{bounds.right}, top #{bounds.top}, bottom #{bounds.bottom}}\n"
        puts block.text
      end
    end

    private

    def page
      FaithAndFarming::Book::Page.load(page_index)
    end

  end

  subcommand "tree", "display the tree" do

    def execute
      FaithAndFarming::Book.pages.walk(TreeListener.new)
    end

    class TreeListener

      def page(index)
        puts "\n--- page #{index} ---"
      end

      def entry(level:, subject:)
        indent = "  " * (level - 1)
        puts "#{level}#{indent}- #{subject.fetch(:name)}"
      end

      private
  
      def method_missing(method, arg)
      end
  
    end

  end

  subcommand "walk", "display the tree" do

    option "--from", "PAGE", "first page", :default => 72, &method(:Integer)
    option "--to", "PAGE", "last page", :default => 720, &method(:Integer)
    
    def execute
      FaithAndFarming::Book.pages(from..to).walk(DumpListener.new)
    end

    class DumpListener

      private
  
      def method_missing(method, arg)
        puts YAML.dump(method => arg)
      end
  
    end
    
  end

  def run(*)
    super
  rescue Errno::EPIPE
  end

end
